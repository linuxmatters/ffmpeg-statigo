name: Go

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    name: Build and test on ${{ matrix.os }} ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-24.04
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
          - os: darwin
            arch: amd64
            runner: macos-15-intel
          - os: darwin
            arch: arm64
            runner: macos-latest
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install libclang for generator
        run: |
          if [ "${{ matrix.os }}" = "linux" ]; then
            sudo apt-get update
            sudo apt-get install -y libclang-dev llvm-dev
          elif [ "${{ matrix.os }}" = "darwin" ]; then
            brew install llvm
          fi

      - name: Run generator
        run: go run ./internal/generator
        continue-on-error: true

      - name: Check for generated code differences
        run: |
          if ! git diff --quiet *.gen.go; then
            echo "::notice title=Generated Code Diff on ${{ matrix.os }}/${{ matrix.arch }}::Generated bindings differ from committed version. This may be platform-specific behavior."
            git diff *.gen.go > /tmp/generator-diff.txt
            echo "::group::Generator Diff"
            cat /tmp/generator-diff.txt
            echo "::endgroup::"
          else
            echo "::notice title=Generated Code Match on ${{ matrix.os }}/${{ matrix.arch }}::Generated bindings match committed version."
          fi
        continue-on-error: true

      - name: Build
        run: go build -v .

      - name: Test
        run: go test -v .
